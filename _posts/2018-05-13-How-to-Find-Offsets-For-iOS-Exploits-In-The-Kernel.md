I was working on a private iOS 8.4.1 Jailbreak for my iPod Touch 5th Generation for practicing purposes and I've decided to use CVE-2016-4655 in order to leak the Kernel Base. The Kernel base will be required, especially since I need to patch a few things up. The iOS 8.4.1 Kernel is randomized using kASLR by iBoot at every boot of the system so we'll need to calculate the randomized address of the components we wanna patch. Let's take `_kernel_pmap` as an example. If I disassemble the `kernelcache.release.n78` using IDA Pro or Hopper Disassembler, the `_kernel_pmap` can be located at address `0x803a311c` in the `__DATA segment`, but this will not remain true for the live running kernel, so I can't just patch PMAP using that address. In this case, I need to find the offset, add the Kernel Base and calculate the live, slid address of `_kernel_pmap`.

Of course, `_kernel_pmap` is not the only component that needs patching in a jailbreak, and for each component, the address you find in IDA or in Hopper won't match the live Kernel because of kASLR (Kernel Address Space Layout Randomization). Of course, since my example is on iOS 8.4.1, and therefore before the changes implemented in iOS 10 regarding the encryption of the firmware, before we can do any sort of disassembly we need to decrypt the Kernel with the appropriate Key and IV. These can be located, fortunately, on TheiPhoneWiki for all 32-Bit devices and some 64-Bit devices too.

When you're building a jailbreak, there is no legal notice that you MUST do everything from scratch or otherwise your PC will catch fire. Nope. You can reuse parts of someone else's code (publicly released open source exploits, PoCs, etc.), as long as you give proper credits and you respect the license. In my case, I was going to use Trident by benjamin-42 on GitHub, but I realized that the `offsetfinder.c` from his project does not have the offsets for iPod Touch 5th Generation on iOS 8.4.1 which means that the project is totally useless for my device until I find the correct offsets. That was the reason I've decided to put together this write-up.

So, without further ado, let's begin() our journey!

### Getting started.
At first, we need obtain ourselves a copy of the iOS 8.4.1 (or the version you intend to use this for) Kernel. Fortunately, the decryption keys are available, so we don't need to dump the kernel from the memory of the device (much more painful and hard to do and requires exploit and more coding). However, It's not pink flowers and unicorns here either. We need to decrypt the kernel using `xpwntool`. All the tools refered in this write-up will be linked at the end of the article. Before we can decrypt it, we need to grab it. We have two options: Either download the whole iOS 8.4.1 IPSW for iPod Touch 5th Generation (in my case), which may not be that bad depending on your internet speed, or download only the `kernelcache.release.n78` which is better for me since I am currently living in a part of Italy where the internet speed is not very great.

### Obtaining the `kernelcache.release.xx` file
For this task we can use `PZB` or `Partial Zip Browser` by @tihmstar. The source code is available at the end of the write-up.
Once we have the source code, we can compile it and run it in Terminal.
PZB has the following syntax: `./pzb [parameter] <url to zip>`.

With this in place, we can first run `./pzb -l <IPSW LINK>` and see the name of all the files, including the Kernel file which in my case is called `kernelcache.release.n78`. Then we can simply run `./pzb -g file_to_download <IPSW LINK>` and get the file. My final command would be `./pzb -g kernelcache.release.n78 http://appldnld.apple.com/ios8.4.1/031-31324-20150812-5AAFE21E-3C90-11E5-BEE3-6A1C3A53DB92/iPod5,1_8.4.1_12H321_Restore.ipsw`

Now that I have my `kernelcache.release.n78` in my User directory (`geosn0w` directory in my case), I am able to run it through `xpwntool` to decrypt it. Xpwntool's syntax for our needs looks like this `xpwntool <infile> <outfile> [-k <key>] [-iv <key>]`
Both the `Key` and the `IV` can be found on TheiPhoneWiki on the Firmware page. Each device has a different `Key` and a different `IV` for the same iOS version. The reason for that is that the keys used to be generated using the baked in `GID key` that cannot be retrieved. Using an `iBoot` or a `SecureROM` exploit one can access the built-in `AES Engine` and generate the keys from the KBAGS of the encrypted files. A tedious process that requires 0day on newer devices. Fortunately, Apple stopped encrypting most components in iSO 10.x

My Final command on Xpwntool is `/Users/geosn0w/Desktop/ToolChain/Pentesting\ Tools\ \&\ Other/xpwntool /Users/geosn0w/Desktop/kernelcache.release.n78 /Users/geosn0w/Desktop/kernelcache.release.DECRYPTED -k e7904495a19966d622389ce0e1113f4f00e0fc7c0fa65c4d66e79dd12450edf9 -iv c96b701e3dc9ae4d07bf722a4cb50011`
The command should create a new file called `kernelcache.release.DECRYPTED` on my Desktop and the file should be recognized as `Mach-O executable arm_v7` if you run it through the `file` command in terminal. 
